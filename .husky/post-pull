#!/bin/sh

echo "ğŸ” Running post-pull hook..."

# Enforce strict lockfile sync
echo "ğŸ“¦ Installing dependencies with strict lockfile sync..."
if ! bun install --frozen-lockfile; then
  echo "âŒ bun install failed at $(date -u '+%Y-%m-%d %H:%M:%S GMT')."
  echo "   Please resolve lockfile or dependency issues before continuing."
  exit 1
fi

echo "âœ… Dependencies are up to date."

# Detect if database package was touched in the pull
files_branch=$(git diff --name-only origin/main...HEAD)
database_changed=$(echo "$files_branch" | grep -E '^packages/database/' | sort -u)

if [ -n "$database_changed" ]; then
  echo "ğŸ’¡ Reminder: Since packages/database changed, you may need to run:"
  echo "   bun run db:generate"
  echo "   bun run db:push"
fi

echo "ğŸ’¡ For all projects, ensure database connection strings are configured correctly."

# Success summary with timestamp
echo "ğŸ‰ Post-pull checks completed successfully at $(date -u '+%Y-%m-%d %H:%M:%S GMT')."
