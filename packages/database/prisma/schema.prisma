// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Creator {
  id         String   @id @default(uuid())
  name       String
  slug       String   @unique
  bio        String? // Creator bio/description
  avatar     String? // Profile image URL
  type       String // "INDIVIDUAL" | "CHURCH"
  isVerified Boolean  @default(false)
  settings   String? // JSON string for settings
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // A user can be a creator (one-to-one)
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  // Creator's content and management
  ghostAuthorMappings GhostAuthorMapping[]
  subscriptions       Subscription[] // Users subscribed to this creator
  userRoles           UserRole[] // People invited to manage this creator's content

  @@index([slug])
  @@index([type])
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String?
  ghostMemberId String?  @unique // Ghost Members API ID
  isCreator     Boolean  @default(false) // Can this user be a creator?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Optional: User can be a creator
  creator Creator?

  // User's subscriptions to creators
  subscriptions Subscription[]

  // User's roles (can manage multiple creators)
  roles UserRole[]

  // If user is a creator, their author mapping
  ghostAuthorMapping GhostAuthorMapping?

  @@index([email])
  @@index([ghostMemberId])
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique // CREATOR, CREATOR_ADMIN, SUBSCRIBER
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users UserRole[]

  @@index([name])
}

model UserRole {
  userId    String
  roleId    String
  creatorId String // Role is scoped to a specific creator

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  role    Role    @relation(fields: [roleId], references: [id], onDelete: Cascade)
  creator Creator @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@id([userId, roleId, creatorId])
  @@index([userId])
  @@index([creatorId])
}

model GhostAuthorMapping {
  id            String   @id @default(uuid())
  ghostAuthorId String   @unique // Ghost author ID
  creatorId     String // Maps to creator
  userId        String   @unique // The creator user
  createdAt     DateTime @default(now())

  creator Creator @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([ghostAuthorId])
  @@index([creatorId])
  @@index([userId])
}

model Subscription {
  id            String   @id @default(uuid())
  userId        String
  creatorId     String // User subscribes to creator
  ghostMemberId String // Ghost Members API member ID
  contentType   String // "DEVOTIONS" | "ARTICLES" | "ALL"
  isActive      Boolean  @default(true)
  preferences   String? // JSON string for preferences
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  creator Creator @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@unique([userId, creatorId]) // User can only subscribe once per creator
  @@index([userId])
  @@index([creatorId])
  @@index([ghostMemberId])
}
